# BodyApp Development Rules - STRICT ENFORCEMENT

## Critical Rules (NEVER VIOLATE)

### 1. File Length Limit
- **MAXIMUM 1000 lines per file**
- If ANY file exceeds 1000 lines:
  - STOP all other work immediately
  - Refactor the file into smaller modules
  - Move code to appropriate folders
  - Resume work only after refactoring is complete

### 2. Markdown File Policy
- **ONLY ONE README.md allowed in root folder**
- Optional: One README in backend folder, one in frontend folder
- **NEVER create**:
  - QUICK_START.md
  - MVP_WORKFLOW.md
  - IMPLEMENTATION_SUMMARY.md
  - CONTRIBUTING.md
  - CHANGELOG.md
  - Or ANY other markdown files
- All documentation goes in the single root README.md
- Updates must be in README.md, not new files
- If you need to show documentation, output it as rich text in chat

### 3. Root Folder Policy
- **ONLY these files allowed in root**:
  - README.md
  - requirements.txt (Python dependencies)
  - package.json (if needed for project-wide scripts)
  - .gitignore
  - .cursorrules
  - .env (or .env.example)
  - Start scripts (start.sh, start.bat)
- **EVERYTHING else** must be in proper subfolders

### 4. NEVER CREATE MOCK COMPONENTS
- **NEVER create mock/placeholder components or functions**
- **ALWAYS implement real functionality**
- If a library needs installation/setup, do that first
- If something doesn't work, fix the root cause
- Mock data for testing is OK, but mock UI components are FORBIDDEN

### 5. Terminal Health Monitoring (CRITICAL - Prevents Shell Tool Breakage)
- **Problem**: After ~3 hours of heavy shell usage, PowerShell processes accumulate and shell tool stops capturing output (PID -1 errors)
- **Solution**: Agent must monitor and clean up terminal processes periodically

#### Monitoring Rules:
- **Check terminal health every 10-15 shell commands**
- **Track last cleanup in `.terminal_health_check` file in project root**
- **If last cleanup was >2 hours ago OR PowerShell process count >25, perform cleanup**

#### Health Check Commands:
```powershell
# Check PowerShell process count
(Get-Process powershell,pwsh -ErrorAction SilentlyContinue).Count

# Check terminal state files
(Get-ChildItem "$env:USERPROFILE\.cursor\projects\*\terminals\*.txt" -Recurse -ErrorAction SilentlyContinue).Count
```

#### Cleanup Process (when needed):
```powershell
# 1. Kill orphaned PowerShell processes without main windows
Get-Process pwsh,powershell -ErrorAction SilentlyContinue | Where-Object {$_.MainWindowTitle -eq ""} | Stop-Process -Force

# 2. Clear terminal state files for this project only
Remove-Item "$env:USERPROFILE\.cursor\projects\c-Users-peter-Github-bodyapp\terminals\*.txt" -Force -ErrorAction SilentlyContinue
```

#### After Cleanup:
- Update `.terminal_health_check` file with current timestamp
- Inform user: "ğŸ§¹ Cleaned up terminal processes to prevent shell tool issues"
- Continue with normal work

#### Warning Signs:
- If PowerShell process count >40: **URGENT cleanup needed**
- If shell commands return PID -1: **Already broken, alert user to restart Cursor**
- If output capture fails: **Alert user immediately**

#### Implementation:
- Agent checks `.terminal_health_check` file timestamp periodically
- If file doesn't exist or timestamp >2 hours old, run cleanup
- This is AUTOMATIC - no user intervention needed
- Keeps development flowing without shell tool failures

## Backend Structure Rules

### Folder Organization
```
be/
â”œâ”€â”€ api/              # All API endpoints (routers)
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ physique.py   # Physique analysis endpoints
â”‚   â”œâ”€â”€ users.py      # User management endpoints
â”‚   â””â”€â”€ health.py     # Health check endpoints
â”œâ”€â”€ services/         # Business logic
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ scoring.py    # Scoring algorithms
â”‚   â””â”€â”€ analysis.py   # Analysis services
â”œâ”€â”€ models/           # Database models
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ user.py
â”‚   â””â”€â”€ scan.py
â”œâ”€â”€ database/         # Database layer
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ connection.py
â”‚   â””â”€â”€ repositories.py
â”œâ”€â”€ utils/            # Utility functions
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ validation.py
â”œâ”€â”€ tests/            # All tests
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ test_*.py
â”œâ”€â”€ config.py         # Configuration
â””â”€â”€ main.py           # ONLY app initialization and router registration
```

### Backend main.py Rules
- **ONLY contains**:
  - App initialization
  - CORS setup
  - Router registration
  - Startup/shutdown events
- **MAXIMUM 200 lines**
- **NO endpoint definitions** (all in api/ folder)
- **NO business logic** (all in services/ folder)

## Frontend Structure Rules

### Folder Organization
```
fe/
â”œâ”€â”€ app/              # Next.js app router
â”œâ”€â”€ components/       # React components (max 300 lines each)
â”œâ”€â”€ lib/              # Utilities and helpers
â”œâ”€â”€ services/         # API calls and business logic
â”œâ”€â”€ hooks/            # Custom React hooks
â”œâ”€â”€ types/            # TypeScript types
â””â”€â”€ styles/           # Global styles
```

### Component Rules
- Each component: **MAXIMUM 300 lines**
- If larger, split into sub-components
- Keep logic in hooks or services

## General Code Quality Rules

### Modularity
- Every file must have a single, clear responsibility
- If a file does multiple things, split it
- Prefer many small files over few large files

### Naming Conventions
- Files: snake_case.py (Python), kebab-case.tsx (TypeScript)
- Classes: PascalCase
- Functions: snake_case (Python), camelCase (TypeScript)
- Constants: UPPER_CASE

### Import Organization
- Standard library imports first
- Third-party imports second
- Local imports last
- Alphabetically sorted within each group

## Refactoring Triggers

### Immediate Refactoring Required When:
1. Any file exceeds 1000 lines
2. A function exceeds 100 lines
3. More than 3 levels of nesting
4. Duplicate code appears in 3+ places
5. main.py contains endpoint definitions

### Refactoring Process:
1. Stop current work
2. Create new files in appropriate folders
3. Move code to new files
4. Update imports
5. Test that everything works
6. Continue with original task

## Documentation Rules

### README.md Structure (ONLY file for docs)
```markdown
# BodyApp

## Quick Start
- How to install dependencies
- How to start backend
- How to start frontend
- How to run tests

## Project Structure
- Overview of folders
- Tech stack

## Main Workflow
- User flow through the app
- API endpoints overview

## Development
- Code organization philosophy
- How to add new features
- Testing strategy

## Deployment
- How to deploy
```

### Code Comments
- Use docstrings for all functions/classes
- Explain WHY, not WHAT
- Keep comments up to date

## Technology Stack

### Backend
- FastAPI (web framework)
- SQLAlchemy (ORM)
- SQLite (database for MVP, PostgreSQL later)
- Pydantic (validation)

### Frontend  
- Next.js 14 (React framework)
- TypeScript (type safety)
- MediaPipe (pose detection)

## Testing Rules

- Every service function must have tests
- Tests in be/tests/ or fe/tests/
- Filename: test_[module_name].py
- Run tests before committing

## Error Handling

- All API endpoints must have try-catch
- Return user-friendly error messages
- Log errors for debugging
- Never expose internal errors to users

## Performance Rules

- Database queries: Add indexes for frequent queries
- Frontend: Use React.memo for expensive components
- API: Async/await for I/O operations
- Images: Compress before storing

## Security Rules

- Never commit API keys or secrets
- Use environment variables
- Validate all user inputs
- Sanitize database queries

## Git Rules

- Commit often, small commits
- Clear commit messages
- Don't commit large files
- Keep .gitignore updated

## Design System

### Color Palette (STRICT - NEVER VIOLATE)
- **Primary Green**: `#2E7D32` or `#388E3C` (plant leaf green - not too dark, not avocado)
- **Primary Black**: `#000000` or `#1a1a1a` (predominant background color)
- **Accent Gray**: `#e0e0e0` or `#bdbdbd` (light gray for workout/active elements)
- **Success Green**: `#4CAF50` (for positive actions)
- **Warning Orange**: `#FF9800` (for attention)
- **Error Red**: `#f44336` (for errors only)

### NEVER USE:
- âŒ Purple (`#667eea`, `#764ba2`) - WRONG
- âŒ Rainbow colors
- âŒ Bright/neon colors

### Gradients
- Primary: `linear-gradient(135deg, #2E7D32 0%, #1b5e20 100%)`
- Workout: `linear-gradient(135deg, #424242 0%, #212121 100%)`

## Summary

**The Philosophy:**
- Small, focused files
- Clear folder structure  
- Single README.md
- Modular, testable code
- Refactor before it's too late
- Consistent dark green + black color scheme

**The Golden Rule:**
If you're about to create a 1000+ line file or a new markdown file, STOP and refactor first.

